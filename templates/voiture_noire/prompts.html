{% extends './base.html' %}

{% block stylesheet %}
<link rel="stylesheet" href="/static/voiture_noire/prompts.css">
{% endblock %}

{% block title %}
    Les thÃ¨mes de la Petite Voiture Noire
{% endblock %}

{% block content %}
<h1>Nos thÃ¨mes</h1>

<hr>

<section class="prompt-handler">
    <!-- <p>Les thÃ¨mes peuvent Ãªtre choisis par type de couple ou par demandeur.</p> -->
    <details class="detail-prompt-post">
        <summary>
          Proposer un thÃ¨me
        </summary>

        <form method="post" action="{% url 'voiture_noire:post_prompt' %} "class="form-prompt-post form-main">
            {% csrf_token %}
            <label for="id_likes">Type :</label>
            {{ form.pairing_type }}
            <label for="id_dislikes">ThÃ¨me :</label>
            {{ form.body }}
            <button type="submit">Envoyer</button>
        </form>    
    </details>

        <!-- <p>Les thÃ¨mes peuvent Ãªtre choisis par type de couple ou par demandeur.</p> -->
    <section class="section-prompt-list">
        <h2 class="h2-prompt-table">Les thÃ¨mes</h2>

        <p class="p-prompt-table-explanation">
            Les thÃ¨mes peuvent Ãªtre triÃ©s par type de couple, par demandeur, par ordre alphabÃ©tique
            (chacun ses fantasmes) et, enfin, par s'ils sont ou non dans vos requÃªtes.
        </p>

        <table class="table-prompt-list">
            <tr>
                <th class="prompt-type">
                    <form method="post" class="form-prompt-table-sorter">
                        {% csrf_token %}
                        <input type="text" hidden name="sort_value" value="pairing_type">
                        <button type="submit">â‡“ Type</button>
                    </form>
                </th>
                <th class="prompt-body">
                    <form method="post" class="form-prompt-table-sorter">
                        {% csrf_token %}
                        <input type="text" hidden name="sort_value" value="body">
                        <button type="submit">â‡“ ThÃ¨me</button>
                    </form>
                </th>
                <th class="prompt-supporters">
                    <form method="post" class="form-prompt-table-sorter">
                        {% csrf_token %}
                        <input type="text" hidden name="sort_value" value="supporters">
                        <button type="submit">â‡“ IntÃ©ressÃ©s</button>
                    </form>
                </th>
                <th class="prompt-button">
                    <form method="post" class="form-prompt-table-sorter">
                        {% csrf_token %}
                        <input type="text" hidden name="sort_value" value="user_likes">
                        <button type="submit">â‡“â‡“â‡“</button>
                    </form>
                </th>
            </tr>
            {% for prompt in prompt_list %}
            <tr>
                <td class="prompt-type">
                    {% if prompt.pairing_type == 'FF' %}
                        F/F
                    {% elif prompt.pairing_type == 'MM' %}
                        M/M
                    {% elif prompt.pairing_type == 'FM' %}
                        F/M
                    {% elif prompt.pairing_type == 'ANY' %}
                        N'importe
                    {% elif prompt.pairing_type == 'ETC' %}
                        Autre
                    {% elif prompt.pairing_type == 'GEN' %}
                        GÃ©nÃ©ral
                    {% endif %}
                </td>
                
                <td class="prompt-body">
                    {{ prompt.body }}
                </td>

                <td class="prompt-supporters">
                    <!-- NOTE : GÃ©rer les virgules -->
                    {% for person in prompt.supporters.all %}
                        {% if forloop.last %}
                            {{ person.username.capitalize }}
                        {% else %}
                            {{ person.username.capitalize }},
                        {% endif %}

                    {% endfor %}
                </td>

                <td class="prompt-button">
                    {% if user in prompt.supporters.all %}
                        <form
                            class="form-favourite-logic"
                            action="{% url 'voiture_noire:unfavourite' prompt.id %} "
                            method="post"
                        >
                            {% csrf_token %}
                            <button type="submit" titre="Retirer des favoris">ðŸ’”</button>
                        </form>
                    {% else %}
                        <form 
                            class="form-favourite-logic"
                            action="{% url 'voiture_noire:favourite' prompt.id %} "
                            method="post"
                        >
                            {% csrf_token %}
                            <button type="submit" title="Ajouter aux favoris">ðŸ’›</button>
                        </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </section>
</section>

<script>
    const userName = "{{ request.user.username }}"

    document.addEventListener("submit", function (e) {
        // e.preventDefault(); 
        const submittedForm = e.target
        const btn = e.submitter;
        console.log(e)
        console.log(e.submitter)

        if (submittedForm.classList.contains("form-favourite-logic")) {
            e.preventDefault();
            switchFavBtns(btn)
            handleFormLogic(submittedForm)
            handleSupporterNames(e.target)
        }
    });
    
    async function handleFormLogic(form) {
        const formData = new FormData(form);
        const response = await fetch(
            form.action, {
                method: form.method,
                body: formData,
            }
        )

        if (!response.ok) {
            throw new Error(`Response status: ${response.status}`);
        }
    }

    function switchFavBtns(btn) {
        colour = btn.innerText
        const heart = colour === "ðŸ’›"? "ðŸ’”": "ðŸ’›"
        btn.innerText = heart
    }

    function handleSupporterNames(form) {
        const parentCell = form.parentElement;
        const supporterCell = parentCell.previousSibling.previousSibling
        let supportersList = supporterCell.innerText

        if (supportersList.includes(userName)) {
            const withComma = userName + ", "
            supportersList = supportersList.replace(withComma, "")
            supportersList = supportersList.replace(userName, "")
        } else {
            const withComma = ", " + userName

            if (supportersList.length === 0) {
                supportersList = userName    
            } else {
                supportersList = supportersList + withComma
            }
        }
        
        supporterCell.innerText = supportersList
    }
</script>
{% endblock %}